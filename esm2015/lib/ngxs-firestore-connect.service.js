import { Injectable } from '@angular/core';
import { Store, Actions, ofActionDispatched } from '@ngxs/store';
import { tap, catchError, mergeMap, takeUntil, finalize, filter, take, share } from 'rxjs/operators';
import { race, Subject, defer, of } from 'rxjs';
import { StreamConnected, StreamEmitted, StreamDisconnected, StreamErrored } from './action-decorator-helpers';
import { NgxsFirestoreConnectActions } from './ngxs-firestore-connect.actions';
import { DisconnectAll, Disconnect } from './actions';
import { attachAction } from './attach-action';
import { NgxsFirestoreState } from './ngxs-firestore.state';
import * as i0 from "@angular/core";
import * as i1 from "@ngxs/store";
function defaultTrackBy(action) {
    return '';
}
function streamId(opts) {
    let id = `${opts.actionType.type}`;
    if (opts.trackBy(opts.action)) {
        id = id.concat(` (${opts.trackBy(opts.action)})`);
    }
    return id;
}
function tapOnce(fn) {
    return (source) => defer(() => {
        let first = true;
        return source.pipe(tap((payload) => {
            if (first) {
                fn(payload);
            }
            first = false;
        }));
    }).pipe(share());
}
export class NgxsFirestoreConnect {
    constructor(store, actions) {
        this.store = store;
        this.actions = actions;
        this.firestoreConnectionsSub = [];
        this.activeFirestoreConnections = [];
        this.actionsPending = [];
    }
    /**
     * Connect a query that will dispatch a `StreamEmitted` action on each emission.
     *
     * @param actionType Action to connect with
     * @param opts.to Firestore Query to connect with
     * @param opts.trackBy used to allow multiple connections for a same action, and Disconnect them individually
     * @param opts.connectedActionFinishesOn complete connected action on first emit or stream completed
     * @param opts.cancelPrevious cancel previous connected action, (when used combined with trackBy, will cancel stream with same id)
     */
    connect(actionType, opts) {
        const connectedActionFinishesOn = opts.connectedActionFinishesOn || 'FirstEmit';
        const trackBy = opts.trackBy || defaultTrackBy;
        const cancelPrevious = opts.cancelPrevious;
        const subjects = {};
        function getSubjects(id) {
            if (!subjects[id]) {
                const actionCompletedHandlerSubject = new Subject();
                subjects[id] = {
                    actionCompletedHandlerSubject
                };
            }
            return subjects[id];
        }
        attachAction(NgxsFirestoreState, actionType, (_stateContext, action) => {
            const { actionCompletedHandlerSubject } = getSubjects(streamId({ actionType, action, trackBy }));
            const completed$ = actionCompletedHandlerSubject.asObservable().pipe(take(1));
            if (cancelPrevious) {
                return completed$;
            }
            if (this.activeFirestoreConnections.includes(streamId({ actionType, action, trackBy }))) {
                return;
            }
            if (this.actionsPending.includes(streamId({ actionType, action, trackBy }))) {
                return completed$;
            }
            return completed$;
        });
        const actionDispatched$ = this.actions.pipe(ofActionDispatched(actionType), 
        // filter actions not connected already
        // or cancelPrevious
        filter((action) => {
            return cancelPrevious || !this.activeFirestoreConnections.includes(streamId({ actionType, action, trackBy }));
        }), 
        // filter actions dispatched on same tick
        filter((action) => {
            return !this.actionsPending.includes(streamId({ actionType, action, trackBy }));
        }), tap((action) => {
            this.actionsPending.push(streamId({ actionType, action, trackBy }));
        }));
        const firestoreStreamHandler$ = (action) => {
            const streamFn = opts.to;
            return streamFn(action).pipe(
            // connected
            tapOnce((_) => {
                const StreamConnectedClass = StreamConnected(actionType);
                this.store.dispatch(new StreamConnectedClass(action));
                this.activeFirestoreConnections.push(streamId({ actionType, action, trackBy }));
                // remove from actionsPending once connected
                this.actionsPending.splice(this.actionsPending.indexOf(streamId({ actionType, action, trackBy })), 1);
                this.store.dispatch(new NgxsFirestoreConnectActions.StreamConnected(streamId({ actionType, action, trackBy })));
            }), 
            // emmited
            tap((payload) => {
                const StreamEmittedClass = StreamEmitted(actionType);
                this.store.dispatch(new StreamEmittedClass(action, payload));
                this.store.dispatch(new NgxsFirestoreConnectActions.StreamEmitted({
                    id: streamId({ actionType, action, trackBy }),
                    items: payload
                }));
            }), 
            // completed if FirstEmit
            tapOnce(() => {
                if (connectedActionFinishesOn === 'FirstEmit') {
                    const { actionCompletedHandlerSubject } = getSubjects(streamId({ actionType, action, trackBy }));
                    actionCompletedHandlerSubject.next(action);
                }
            }), 
            // disconnect on Disconnect
            takeUntil(race(this.actions.pipe(ofActionDispatched(DisconnectAll)), this.actions.pipe(ofActionDispatched(Disconnect)).pipe(filter((disconnectAction) => {
                const { payload } = disconnectAction;
                if (!payload) {
                    return false;
                }
                const disconnectedStreamId = streamId({
                    actionType: payload.constructor || payload,
                    action: disconnectAction.payload,
                    trackBy
                });
                if (disconnectedStreamId === streamId({ actionType, action, trackBy })) {
                    return true;
                }
                return false;
            })))), 
            // disconnect on action re-dispatched
            takeUntil(this.actions.pipe(ofActionDispatched(actionType), filter((dispatchedAction) => {
                if (!cancelPrevious) {
                    return false;
                }
                //SELF
                if (dispatchedAction === action) {
                    return false;
                }
                const dispatchedActionStreamId = streamId({
                    actionType,
                    action: dispatchedAction,
                    trackBy
                });
                return dispatchedActionStreamId === streamId({ actionType, action, trackBy });
            }))), finalize(() => {
                const StreamDisconnectedClass = StreamDisconnected(actionType);
                this.store.dispatch(new StreamDisconnectedClass(action));
                this.store.dispatch(new NgxsFirestoreConnectActions.StreamDisconnected(streamId({ actionType, action, trackBy })));
                this.activeFirestoreConnections.splice(this.activeFirestoreConnections.indexOf(streamId({ actionType, action, trackBy })), 1);
                // completed if StreamCompleted
                if (connectedActionFinishesOn === 'StreamCompleted') {
                    const { actionCompletedHandlerSubject } = getSubjects(streamId({ actionType, action, trackBy }));
                    actionCompletedHandlerSubject.next(action);
                }
            }), catchError((err) => {
                const { actionCompletedHandlerSubject } = getSubjects(streamId({ actionType, action, trackBy }));
                actionCompletedHandlerSubject.error(err);
                const StreamErroredClass = StreamErrored(actionType);
                this.store.dispatch(new StreamErroredClass(action, err));
                return of({});
            }));
        };
        this.firestoreConnectionsSub.push(actionDispatched$.pipe(mergeMap(firestoreStreamHandler$)).subscribe());
    }
    ngOnDestroy() {
        if (this.firestoreConnectionsSub) {
            this.firestoreConnectionsSub.forEach((sub) => sub.unsubscribe());
        }
    }
}
NgxsFirestoreConnect.ɵprov = i0.ɵɵdefineInjectable({ factory: function NgxsFirestoreConnect_Factory() { return new NgxsFirestoreConnect(i0.ɵɵinject(i1.Store), i0.ɵɵinject(i1.Actions)); }, token: NgxsFirestoreConnect, providedIn: "root" });
NgxsFirestoreConnect.decorators = [
    { type: Injectable, args: [{ providedIn: 'root' },] }
];
NgxsFirestoreConnect.ctorParameters = () => [
    { type: Store },
    { type: Actions }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4cy1maXJlc3RvcmUtY29ubmVjdC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9uZ3hzLWZpcmVzdG9yZS1jb25uZWN0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBYSxNQUFNLGVBQWUsQ0FBQztBQUN0RCxPQUFPLEVBQUUsS0FBSyxFQUFjLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUM3RSxPQUFPLEVBQUUsR0FBRyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JHLE9BQU8sRUFBYyxJQUFJLEVBQWdCLE9BQU8sRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzFFLE9BQU8sRUFBRSxlQUFlLEVBQUUsYUFBYSxFQUFFLGtCQUFrQixFQUFFLGFBQWEsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQy9HLE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQy9FLE9BQU8sRUFBRSxhQUFhLEVBQUUsVUFBVSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3RELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvQyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQzs7O0FBTzVELFNBQVMsY0FBYyxDQUFDLE1BQVc7SUFDakMsT0FBTyxFQUFFLENBQUM7QUFDWixDQUFDO0FBRUQsU0FBUyxRQUFRLENBQUMsSUFBK0U7SUFDL0YsSUFBSSxFQUFFLEdBQUcsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ25DLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUU7UUFDN0IsRUFBRSxHQUFHLEVBQUUsQ0FBQyxNQUFNLENBQUMsS0FBSyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDbkQ7SUFDRCxPQUFPLEVBQUUsQ0FBQztBQUNaLENBQUM7QUFFRCxTQUFTLE9BQU8sQ0FBSSxFQUFtQjtJQUNyQyxPQUFPLENBQUMsTUFBdUIsRUFBRSxFQUFFLENBQ2pDLEtBQUssQ0FBQyxHQUFHLEVBQUU7UUFDVCxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUM7UUFDakIsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUNoQixHQUFHLENBQUksQ0FBQyxPQUFPLEVBQUUsRUFBRTtZQUNqQixJQUFJLEtBQUssRUFBRTtnQkFDVCxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUM7YUFDYjtZQUNELEtBQUssR0FBRyxLQUFLLENBQUM7UUFDaEIsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO0FBQ3JCLENBQUM7QUFHRCxNQUFNLE9BQU8sb0JBQW9CO0lBSy9CLFlBQW9CLEtBQVksRUFBVSxPQUFnQjtRQUF0QyxVQUFLLEdBQUwsS0FBSyxDQUFPO1FBQVUsWUFBTyxHQUFQLE9BQU8sQ0FBUztRQUpsRCw0QkFBdUIsR0FBbUIsRUFBRSxDQUFDO1FBQzdDLCtCQUEwQixHQUFhLEVBQUUsQ0FBQztRQUMxQyxtQkFBYyxHQUFhLEVBQUUsQ0FBQztJQUV1QixDQUFDO0lBRTlEOzs7Ozs7OztPQVFHO0lBQ0gsT0FBTyxDQUNMLFVBQTRCLEVBQzVCLElBS0M7UUFFRCxNQUFNLHlCQUF5QixHQUFHLElBQUksQ0FBQyx5QkFBeUIsSUFBSSxXQUFXLENBQUM7UUFDaEYsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sSUFBSSxjQUFjLENBQUM7UUFDL0MsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQztRQU0zQyxNQUFNLFFBQVEsR0FBd0MsRUFBRSxDQUFDO1FBQ3pELFNBQVMsV0FBVyxDQUFDLEVBQVU7WUFDN0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsRUFBRTtnQkFDakIsTUFBTSw2QkFBNkIsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO2dCQUNwRCxRQUFRLENBQUMsRUFBRSxDQUFDLEdBQUc7b0JBQ2IsNkJBQTZCO2lCQUM5QixDQUFDO2FBQ0g7WUFFRCxPQUFPLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN0QixDQUFDO1FBRUQsWUFBWSxDQUFDLGtCQUFrQixFQUFFLFVBQVUsRUFBRSxDQUFDLGFBQWEsRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNyRSxNQUFNLEVBQUUsNkJBQTZCLEVBQUUsR0FBRyxXQUFXLENBQUMsUUFBUSxDQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFFakcsTUFBTSxVQUFVLEdBQUcsNkJBQTZCLENBQUMsWUFBWSxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRTlFLElBQUksY0FBYyxFQUFFO2dCQUNsQixPQUFPLFVBQVUsQ0FBQzthQUNuQjtZQUVELElBQUksSUFBSSxDQUFDLDBCQUEwQixDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUMsRUFBRTtnQkFDdkYsT0FBTzthQUNSO1lBRUQsSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUMsRUFBRTtnQkFDM0UsT0FBTyxVQUFVLENBQUM7YUFDbkI7WUFFRCxPQUFPLFVBQVUsQ0FBQztRQUNwQixDQUFDLENBQUMsQ0FBQztRQUVILE1BQU0saUJBQWlCLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQ3pDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQztRQUM5Qix1Q0FBdUM7UUFDdkMsb0JBQW9CO1FBQ3BCLE1BQU0sQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFO1lBQ2hCLE9BQU8sY0FBYyxJQUFJLENBQUMsSUFBSSxDQUFDLDBCQUEwQixDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNoSCxDQUFDLENBQUM7UUFDRix5Q0FBeUM7UUFDekMsTUFBTSxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUU7WUFDaEIsT0FBTyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ2xGLENBQUMsQ0FBQyxFQUNGLEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFO1lBQ2IsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDdEUsQ0FBQyxDQUFDLENBQ0gsQ0FBQztRQUVGLE1BQU0sdUJBQXVCLEdBQUcsQ0FBQyxNQUFNLEVBQUUsRUFBRTtZQUN6QyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQ3pCLE9BQU8sUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUk7WUFDMUIsWUFBWTtZQUNaLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFO2dCQUNaLE1BQU0sb0JBQW9CLEdBQUcsZUFBZSxDQUFDLFVBQVUsQ0FBQyxDQUFDO2dCQUN6RCxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQ3RELElBQUksQ0FBQywwQkFBMEIsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQ2hGLDRDQUE0QztnQkFDNUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBRXRHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUNqQixJQUFJLDJCQUEyQixDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FDM0YsQ0FBQztZQUNKLENBQUMsQ0FBQztZQUNGLFVBQVU7WUFDVixHQUFHLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtnQkFDZCxNQUFNLGtCQUFrQixHQUFHLGFBQWEsQ0FBQyxVQUFVLENBQUMsQ0FBQztnQkFDckQsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBSSxrQkFBa0IsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQztnQkFDN0QsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQ2pCLElBQUksMkJBQTJCLENBQUMsYUFBYSxDQUFDO29CQUM1QyxFQUFFLEVBQUUsUUFBUSxDQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsQ0FBQztvQkFDN0MsS0FBSyxFQUFFLE9BQU87aUJBQ2YsQ0FBQyxDQUNILENBQUM7WUFDSixDQUFDLENBQUM7WUFDRix5QkFBeUI7WUFDekIsT0FBTyxDQUFDLEdBQUcsRUFBRTtnQkFDWCxJQUFJLHlCQUF5QixLQUFLLFdBQVcsRUFBRTtvQkFDN0MsTUFBTSxFQUFFLDZCQUE2QixFQUFFLEdBQUcsV0FBVyxDQUFDLFFBQVEsQ0FBQyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO29CQUNqRyw2QkFBNkIsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7aUJBQzVDO1lBQ0gsQ0FBQyxDQUFDO1lBQ0YsMkJBQTJCO1lBQzNCLFNBQVMsQ0FDUCxJQUFJLENBQ0YsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsYUFBYSxDQUFDLENBQUMsRUFDcEQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQ3BELE1BQU0sQ0FBQyxDQUFDLGdCQUFnQixFQUFFLEVBQUU7Z0JBQzFCLE1BQU0sRUFBRSxPQUFPLEVBQUUsR0FBRyxnQkFBZ0IsQ0FBQztnQkFDckMsSUFBSSxDQUFDLE9BQU8sRUFBRTtvQkFDWixPQUFPLEtBQUssQ0FBQztpQkFDZDtnQkFDRCxNQUFNLG9CQUFvQixHQUFHLFFBQVEsQ0FBQztvQkFDcEMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxXQUFXLElBQUksT0FBTztvQkFDMUMsTUFBTSxFQUFFLGdCQUFnQixDQUFDLE9BQU87b0JBQ2hDLE9BQU87aUJBQ1IsQ0FBQyxDQUFDO2dCQUNILElBQUksb0JBQW9CLEtBQUssUUFBUSxDQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsQ0FBQyxFQUFFO29CQUN0RSxPQUFPLElBQUksQ0FBQztpQkFDYjtnQkFFRCxPQUFPLEtBQUssQ0FBQztZQUNmLENBQUMsQ0FBQyxDQUNILENBQ0YsQ0FDRjtZQUNELHFDQUFxQztZQUNyQyxTQUFTLENBQ1AsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQ2Ysa0JBQWtCLENBQUMsVUFBVSxDQUFDLEVBQzlCLE1BQU0sQ0FBQyxDQUFDLGdCQUFnQixFQUFFLEVBQUU7Z0JBQzFCLElBQUksQ0FBQyxjQUFjLEVBQUU7b0JBQ25CLE9BQU8sS0FBSyxDQUFDO2lCQUNkO2dCQUNELE1BQU07Z0JBQ04sSUFBSSxnQkFBZ0IsS0FBSyxNQUFNLEVBQUU7b0JBQy9CLE9BQU8sS0FBSyxDQUFDO2lCQUNkO2dCQUNELE1BQU0sd0JBQXdCLEdBQUcsUUFBUSxDQUFDO29CQUN4QyxVQUFVO29CQUNWLE1BQU0sRUFBRSxnQkFBZ0I7b0JBQ3hCLE9BQU87aUJBQ1IsQ0FBQyxDQUFDO2dCQUNILE9BQU8sd0JBQXdCLEtBQUssUUFBUSxDQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDO1lBQ2hGLENBQUMsQ0FBQyxDQUNILENBQ0YsRUFDRCxRQUFRLENBQUMsR0FBRyxFQUFFO2dCQUNaLE1BQU0sdUJBQXVCLEdBQUcsa0JBQWtCLENBQUMsVUFBVSxDQUFDLENBQUM7Z0JBQy9ELElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksdUJBQXVCLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztnQkFDekQsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQ2pCLElBQUksMkJBQTJCLENBQUMsa0JBQWtCLENBQUMsUUFBUSxDQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQzlGLENBQUM7Z0JBQ0YsSUFBSSxDQUFDLDBCQUEwQixDQUFDLE1BQU0sQ0FDcEMsSUFBSSxDQUFDLDBCQUEwQixDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUMsRUFDbEYsQ0FBQyxDQUNGLENBQUM7Z0JBRUYsK0JBQStCO2dCQUMvQixJQUFJLHlCQUF5QixLQUFLLGlCQUFpQixFQUFFO29CQUNuRCxNQUFNLEVBQUUsNkJBQTZCLEVBQUUsR0FBRyxXQUFXLENBQUMsUUFBUSxDQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7b0JBQ2pHLDZCQUE2QixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztpQkFDNUM7WUFDSCxDQUFDLENBQUMsRUFDRixVQUFVLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtnQkFDakIsTUFBTSxFQUFFLDZCQUE2QixFQUFFLEdBQUcsV0FBVyxDQUFDLFFBQVEsQ0FBQyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUNqRyw2QkFBNkIsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBRXpDLE1BQU0sa0JBQWtCLEdBQUcsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFDO2dCQUNyRCxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLGtCQUFrQixDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUV6RCxPQUFPLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUNoQixDQUFDLENBQUMsQ0FDSCxDQUFDO1FBQ0osQ0FBQyxDQUFDO1FBRUYsSUFBSSxDQUFDLHVCQUF1QixDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLHVCQUF1QixDQUFDLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDO0lBQzNHLENBQUM7SUFFRCxXQUFXO1FBQ1QsSUFBSSxJQUFJLENBQUMsdUJBQXVCLEVBQUU7WUFDaEMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7U0FDbEU7SUFDSCxDQUFDOzs7O1lBcE1GLFVBQVUsU0FBQyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUU7OztZQXpDekIsS0FBSztZQUFjLE9BQU8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFN0b3JlLCBBY3Rpb25UeXBlLCBBY3Rpb25zLCBvZkFjdGlvbkRpc3BhdGNoZWQgfSBmcm9tICdAbmd4cy9zdG9yZSc7XG5pbXBvcnQgeyB0YXAsIGNhdGNoRXJyb3IsIG1lcmdlTWFwLCB0YWtlVW50aWwsIGZpbmFsaXplLCBmaWx0ZXIsIHRha2UsIHNoYXJlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgcmFjZSwgU3Vic2NyaXB0aW9uLCBTdWJqZWN0LCBkZWZlciwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFN0cmVhbUNvbm5lY3RlZCwgU3RyZWFtRW1pdHRlZCwgU3RyZWFtRGlzY29ubmVjdGVkLCBTdHJlYW1FcnJvcmVkIH0gZnJvbSAnLi9hY3Rpb24tZGVjb3JhdG9yLWhlbHBlcnMnO1xuaW1wb3J0IHsgTmd4c0ZpcmVzdG9yZUNvbm5lY3RBY3Rpb25zIH0gZnJvbSAnLi9uZ3hzLWZpcmVzdG9yZS1jb25uZWN0LmFjdGlvbnMnO1xuaW1wb3J0IHsgRGlzY29ubmVjdEFsbCwgRGlzY29ubmVjdCB9IGZyb20gJy4vYWN0aW9ucyc7XG5pbXBvcnQgeyBhdHRhY2hBY3Rpb24gfSBmcm9tICcuL2F0dGFjaC1hY3Rpb24nO1xuaW1wb3J0IHsgTmd4c0ZpcmVzdG9yZVN0YXRlIH0gZnJvbSAnLi9uZ3hzLWZpcmVzdG9yZS5zdGF0ZSc7XG5cbmludGVyZmFjZSBBY3Rpb25UeXBlRGVmPFQ+IHtcbiAgdHlwZTogc3RyaW5nO1xuICBuZXcgKC4uLmFyZ3M6IGFueSk6IFQ7XG59XG5cbmZ1bmN0aW9uIGRlZmF1bHRUcmFja0J5KGFjdGlvbjogYW55KSB7XG4gIHJldHVybiAnJztcbn1cblxuZnVuY3Rpb24gc3RyZWFtSWQob3B0czogeyBhY3Rpb25UeXBlOiBBY3Rpb25UeXBlOyBhY3Rpb246IGFueTsgdHJhY2tCeTogKGFjdGlvbjogYW55KSA9PiBzdHJpbmcgfSkge1xuICBsZXQgaWQgPSBgJHtvcHRzLmFjdGlvblR5cGUudHlwZX1gO1xuICBpZiAob3B0cy50cmFja0J5KG9wdHMuYWN0aW9uKSkge1xuICAgIGlkID0gaWQuY29uY2F0KGAgKCR7b3B0cy50cmFja0J5KG9wdHMuYWN0aW9uKX0pYCk7XG4gIH1cbiAgcmV0dXJuIGlkO1xufVxuXG5mdW5jdGlvbiB0YXBPbmNlPFQ+KGZuOiAodmFsdWUpID0+IHZvaWQpIHtcbiAgcmV0dXJuIChzb3VyY2U6IE9ic2VydmFibGU8YW55PikgPT5cbiAgICBkZWZlcigoKSA9PiB7XG4gICAgICBsZXQgZmlyc3QgPSB0cnVlO1xuICAgICAgcmV0dXJuIHNvdXJjZS5waXBlKFxuICAgICAgICB0YXA8VD4oKHBheWxvYWQpID0+IHtcbiAgICAgICAgICBpZiAoZmlyc3QpIHtcbiAgICAgICAgICAgIGZuKHBheWxvYWQpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBmaXJzdCA9IGZhbHNlO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9KS5waXBlKHNoYXJlKCkpO1xufVxuXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxuZXhwb3J0IGNsYXNzIE5neHNGaXJlc3RvcmVDb25uZWN0IGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgcHJpdmF0ZSBmaXJlc3RvcmVDb25uZWN0aW9uc1N1YjogU3Vic2NyaXB0aW9uW10gPSBbXTtcbiAgcHJpdmF0ZSBhY3RpdmVGaXJlc3RvcmVDb25uZWN0aW9uczogc3RyaW5nW10gPSBbXTtcbiAgcHJpdmF0ZSBhY3Rpb25zUGVuZGluZzogc3RyaW5nW10gPSBbXTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHN0b3JlOiBTdG9yZSwgcHJpdmF0ZSBhY3Rpb25zOiBBY3Rpb25zKSB7fVxuXG4gIC8qKlxuICAgKiBDb25uZWN0IGEgcXVlcnkgdGhhdCB3aWxsIGRpc3BhdGNoIGEgYFN0cmVhbUVtaXR0ZWRgIGFjdGlvbiBvbiBlYWNoIGVtaXNzaW9uLlxuICAgKlxuICAgKiBAcGFyYW0gYWN0aW9uVHlwZSBBY3Rpb24gdG8gY29ubmVjdCB3aXRoXG4gICAqIEBwYXJhbSBvcHRzLnRvIEZpcmVzdG9yZSBRdWVyeSB0byBjb25uZWN0IHdpdGhcbiAgICogQHBhcmFtIG9wdHMudHJhY2tCeSB1c2VkIHRvIGFsbG93IG11bHRpcGxlIGNvbm5lY3Rpb25zIGZvciBhIHNhbWUgYWN0aW9uLCBhbmQgRGlzY29ubmVjdCB0aGVtIGluZGl2aWR1YWxseVxuICAgKiBAcGFyYW0gb3B0cy5jb25uZWN0ZWRBY3Rpb25GaW5pc2hlc09uIGNvbXBsZXRlIGNvbm5lY3RlZCBhY3Rpb24gb24gZmlyc3QgZW1pdCBvciBzdHJlYW0gY29tcGxldGVkXG4gICAqIEBwYXJhbSBvcHRzLmNhbmNlbFByZXZpb3VzIGNhbmNlbCBwcmV2aW91cyBjb25uZWN0ZWQgYWN0aW9uLCAod2hlbiB1c2VkIGNvbWJpbmVkIHdpdGggdHJhY2tCeSwgd2lsbCBjYW5jZWwgc3RyZWFtIHdpdGggc2FtZSBpZClcbiAgICovXG4gIGNvbm5lY3Q8VD4oXG4gICAgYWN0aW9uVHlwZTogQWN0aW9uVHlwZURlZjxUPixcbiAgICBvcHRzOiB7XG4gICAgICB0bzogKGFjdGlvbjogVCkgPT4gT2JzZXJ2YWJsZTxhbnk+O1xuICAgICAgdHJhY2tCeT86IChhY3Rpb246IFQpID0+IHN0cmluZztcbiAgICAgIGNvbm5lY3RlZEFjdGlvbkZpbmlzaGVzT24/OiAnRmlyc3RFbWl0JyB8ICdTdHJlYW1Db21wbGV0ZWQnO1xuICAgICAgY2FuY2VsUHJldmlvdXM/OiBib29sZWFuO1xuICAgIH1cbiAgKSB7XG4gICAgY29uc3QgY29ubmVjdGVkQWN0aW9uRmluaXNoZXNPbiA9IG9wdHMuY29ubmVjdGVkQWN0aW9uRmluaXNoZXNPbiB8fCAnRmlyc3RFbWl0JztcbiAgICBjb25zdCB0cmFja0J5ID0gb3B0cy50cmFja0J5IHx8IGRlZmF1bHRUcmFja0J5O1xuICAgIGNvbnN0IGNhbmNlbFByZXZpb3VzID0gb3B0cy5jYW5jZWxQcmV2aW91cztcblxuICAgIGludGVyZmFjZSBDb21wbGV0ZWRIYW5kbGVyIHtcbiAgICAgIGFjdGlvbkNvbXBsZXRlZEhhbmRsZXJTdWJqZWN0OiBTdWJqZWN0PHVua25vd24+O1xuICAgIH1cblxuICAgIGNvbnN0IHN1YmplY3RzOiB7IFtrZXk6IHN0cmluZ106IENvbXBsZXRlZEhhbmRsZXIgfSA9IHt9O1xuICAgIGZ1bmN0aW9uIGdldFN1YmplY3RzKGlkOiBzdHJpbmcpOiBDb21wbGV0ZWRIYW5kbGVyIHtcbiAgICAgIGlmICghc3ViamVjdHNbaWRdKSB7XG4gICAgICAgIGNvbnN0IGFjdGlvbkNvbXBsZXRlZEhhbmRsZXJTdWJqZWN0ID0gbmV3IFN1YmplY3QoKTtcbiAgICAgICAgc3ViamVjdHNbaWRdID0ge1xuICAgICAgICAgIGFjdGlvbkNvbXBsZXRlZEhhbmRsZXJTdWJqZWN0XG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBzdWJqZWN0c1tpZF07XG4gICAgfVxuXG4gICAgYXR0YWNoQWN0aW9uKE5neHNGaXJlc3RvcmVTdGF0ZSwgYWN0aW9uVHlwZSwgKF9zdGF0ZUNvbnRleHQsIGFjdGlvbikgPT4ge1xuICAgICAgY29uc3QgeyBhY3Rpb25Db21wbGV0ZWRIYW5kbGVyU3ViamVjdCB9ID0gZ2V0U3ViamVjdHMoc3RyZWFtSWQoeyBhY3Rpb25UeXBlLCBhY3Rpb24sIHRyYWNrQnkgfSkpO1xuXG4gICAgICBjb25zdCBjb21wbGV0ZWQkID0gYWN0aW9uQ29tcGxldGVkSGFuZGxlclN1YmplY3QuYXNPYnNlcnZhYmxlKCkucGlwZSh0YWtlKDEpKTtcblxuICAgICAgaWYgKGNhbmNlbFByZXZpb3VzKSB7XG4gICAgICAgIHJldHVybiBjb21wbGV0ZWQkO1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5hY3RpdmVGaXJlc3RvcmVDb25uZWN0aW9ucy5pbmNsdWRlcyhzdHJlYW1JZCh7IGFjdGlvblR5cGUsIGFjdGlvbiwgdHJhY2tCeSB9KSkpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5hY3Rpb25zUGVuZGluZy5pbmNsdWRlcyhzdHJlYW1JZCh7IGFjdGlvblR5cGUsIGFjdGlvbiwgdHJhY2tCeSB9KSkpIHtcbiAgICAgICAgcmV0dXJuIGNvbXBsZXRlZCQ7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBjb21wbGV0ZWQkO1xuICAgIH0pO1xuXG4gICAgY29uc3QgYWN0aW9uRGlzcGF0Y2hlZCQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICAgIG9mQWN0aW9uRGlzcGF0Y2hlZChhY3Rpb25UeXBlKSxcbiAgICAgIC8vIGZpbHRlciBhY3Rpb25zIG5vdCBjb25uZWN0ZWQgYWxyZWFkeVxuICAgICAgLy8gb3IgY2FuY2VsUHJldmlvdXNcbiAgICAgIGZpbHRlcigoYWN0aW9uKSA9PiB7XG4gICAgICAgIHJldHVybiBjYW5jZWxQcmV2aW91cyB8fCAhdGhpcy5hY3RpdmVGaXJlc3RvcmVDb25uZWN0aW9ucy5pbmNsdWRlcyhzdHJlYW1JZCh7IGFjdGlvblR5cGUsIGFjdGlvbiwgdHJhY2tCeSB9KSk7XG4gICAgICB9KSxcbiAgICAgIC8vIGZpbHRlciBhY3Rpb25zIGRpc3BhdGNoZWQgb24gc2FtZSB0aWNrXG4gICAgICBmaWx0ZXIoKGFjdGlvbikgPT4ge1xuICAgICAgICByZXR1cm4gIXRoaXMuYWN0aW9uc1BlbmRpbmcuaW5jbHVkZXMoc3RyZWFtSWQoeyBhY3Rpb25UeXBlLCBhY3Rpb24sIHRyYWNrQnkgfSkpO1xuICAgICAgfSksXG4gICAgICB0YXAoKGFjdGlvbikgPT4ge1xuICAgICAgICB0aGlzLmFjdGlvbnNQZW5kaW5nLnB1c2goc3RyZWFtSWQoeyBhY3Rpb25UeXBlLCBhY3Rpb24sIHRyYWNrQnkgfSkpO1xuICAgICAgfSlcbiAgICApO1xuXG4gICAgY29uc3QgZmlyZXN0b3JlU3RyZWFtSGFuZGxlciQgPSAoYWN0aW9uKSA9PiB7XG4gICAgICBjb25zdCBzdHJlYW1GbiA9IG9wdHMudG87XG4gICAgICByZXR1cm4gc3RyZWFtRm4oYWN0aW9uKS5waXBlKFxuICAgICAgICAvLyBjb25uZWN0ZWRcbiAgICAgICAgdGFwT25jZSgoXykgPT4ge1xuICAgICAgICAgIGNvbnN0IFN0cmVhbUNvbm5lY3RlZENsYXNzID0gU3RyZWFtQ29ubmVjdGVkKGFjdGlvblR5cGUpO1xuICAgICAgICAgIHRoaXMuc3RvcmUuZGlzcGF0Y2gobmV3IFN0cmVhbUNvbm5lY3RlZENsYXNzKGFjdGlvbikpO1xuICAgICAgICAgIHRoaXMuYWN0aXZlRmlyZXN0b3JlQ29ubmVjdGlvbnMucHVzaChzdHJlYW1JZCh7IGFjdGlvblR5cGUsIGFjdGlvbiwgdHJhY2tCeSB9KSk7XG4gICAgICAgICAgLy8gcmVtb3ZlIGZyb20gYWN0aW9uc1BlbmRpbmcgb25jZSBjb25uZWN0ZWRcbiAgICAgICAgICB0aGlzLmFjdGlvbnNQZW5kaW5nLnNwbGljZSh0aGlzLmFjdGlvbnNQZW5kaW5nLmluZGV4T2Yoc3RyZWFtSWQoeyBhY3Rpb25UeXBlLCBhY3Rpb24sIHRyYWNrQnkgfSkpLCAxKTtcblxuICAgICAgICAgIHRoaXMuc3RvcmUuZGlzcGF0Y2goXG4gICAgICAgICAgICBuZXcgTmd4c0ZpcmVzdG9yZUNvbm5lY3RBY3Rpb25zLlN0cmVhbUNvbm5lY3RlZChzdHJlYW1JZCh7IGFjdGlvblR5cGUsIGFjdGlvbiwgdHJhY2tCeSB9KSlcbiAgICAgICAgICApO1xuICAgICAgICB9KSxcbiAgICAgICAgLy8gZW1taXRlZFxuICAgICAgICB0YXAoKHBheWxvYWQpID0+IHtcbiAgICAgICAgICBjb25zdCBTdHJlYW1FbWl0dGVkQ2xhc3MgPSBTdHJlYW1FbWl0dGVkKGFjdGlvblR5cGUpO1xuICAgICAgICAgIHRoaXMuc3RvcmUuZGlzcGF0Y2gobmV3IFN0cmVhbUVtaXR0ZWRDbGFzcyhhY3Rpb24sIHBheWxvYWQpKTtcbiAgICAgICAgICB0aGlzLnN0b3JlLmRpc3BhdGNoKFxuICAgICAgICAgICAgbmV3IE5neHNGaXJlc3RvcmVDb25uZWN0QWN0aW9ucy5TdHJlYW1FbWl0dGVkKHtcbiAgICAgICAgICAgICAgaWQ6IHN0cmVhbUlkKHsgYWN0aW9uVHlwZSwgYWN0aW9uLCB0cmFja0J5IH0pLFxuICAgICAgICAgICAgICBpdGVtczogcGF5bG9hZFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICApO1xuICAgICAgICB9KSxcbiAgICAgICAgLy8gY29tcGxldGVkIGlmIEZpcnN0RW1pdFxuICAgICAgICB0YXBPbmNlKCgpID0+IHtcbiAgICAgICAgICBpZiAoY29ubmVjdGVkQWN0aW9uRmluaXNoZXNPbiA9PT0gJ0ZpcnN0RW1pdCcpIHtcbiAgICAgICAgICAgIGNvbnN0IHsgYWN0aW9uQ29tcGxldGVkSGFuZGxlclN1YmplY3QgfSA9IGdldFN1YmplY3RzKHN0cmVhbUlkKHsgYWN0aW9uVHlwZSwgYWN0aW9uLCB0cmFja0J5IH0pKTtcbiAgICAgICAgICAgIGFjdGlvbkNvbXBsZXRlZEhhbmRsZXJTdWJqZWN0Lm5leHQoYWN0aW9uKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pLFxuICAgICAgICAvLyBkaXNjb25uZWN0IG9uIERpc2Nvbm5lY3RcbiAgICAgICAgdGFrZVVudGlsKFxuICAgICAgICAgIHJhY2UoXG4gICAgICAgICAgICB0aGlzLmFjdGlvbnMucGlwZShvZkFjdGlvbkRpc3BhdGNoZWQoRGlzY29ubmVjdEFsbCkpLFxuICAgICAgICAgICAgdGhpcy5hY3Rpb25zLnBpcGUob2ZBY3Rpb25EaXNwYXRjaGVkKERpc2Nvbm5lY3QpKS5waXBlKFxuICAgICAgICAgICAgICBmaWx0ZXIoKGRpc2Nvbm5lY3RBY3Rpb24pID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCB7IHBheWxvYWQgfSA9IGRpc2Nvbm5lY3RBY3Rpb247XG4gICAgICAgICAgICAgICAgaWYgKCFwYXlsb2FkKSB7XG4gICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNvbnN0IGRpc2Nvbm5lY3RlZFN0cmVhbUlkID0gc3RyZWFtSWQoe1xuICAgICAgICAgICAgICAgICAgYWN0aW9uVHlwZTogcGF5bG9hZC5jb25zdHJ1Y3RvciB8fCBwYXlsb2FkLFxuICAgICAgICAgICAgICAgICAgYWN0aW9uOiBkaXNjb25uZWN0QWN0aW9uLnBheWxvYWQsXG4gICAgICAgICAgICAgICAgICB0cmFja0J5XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgaWYgKGRpc2Nvbm5lY3RlZFN0cmVhbUlkID09PSBzdHJlYW1JZCh7IGFjdGlvblR5cGUsIGFjdGlvbiwgdHJhY2tCeSB9KSkge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKVxuICAgICAgICAgIClcbiAgICAgICAgKSxcbiAgICAgICAgLy8gZGlzY29ubmVjdCBvbiBhY3Rpb24gcmUtZGlzcGF0Y2hlZFxuICAgICAgICB0YWtlVW50aWwoXG4gICAgICAgICAgdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgICAgICAgICBvZkFjdGlvbkRpc3BhdGNoZWQoYWN0aW9uVHlwZSksXG4gICAgICAgICAgICBmaWx0ZXIoKGRpc3BhdGNoZWRBY3Rpb24pID0+IHtcbiAgICAgICAgICAgICAgaWYgKCFjYW5jZWxQcmV2aW91cykge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAvL1NFTEZcbiAgICAgICAgICAgICAgaWYgKGRpc3BhdGNoZWRBY3Rpb24gPT09IGFjdGlvbikge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBjb25zdCBkaXNwYXRjaGVkQWN0aW9uU3RyZWFtSWQgPSBzdHJlYW1JZCh7XG4gICAgICAgICAgICAgICAgYWN0aW9uVHlwZSxcbiAgICAgICAgICAgICAgICBhY3Rpb246IGRpc3BhdGNoZWRBY3Rpb24sXG4gICAgICAgICAgICAgICAgdHJhY2tCeVxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZWRBY3Rpb25TdHJlYW1JZCA9PT0gc3RyZWFtSWQoeyBhY3Rpb25UeXBlLCBhY3Rpb24sIHRyYWNrQnkgfSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgIClcbiAgICAgICAgKSxcbiAgICAgICAgZmluYWxpemUoKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IFN0cmVhbURpc2Nvbm5lY3RlZENsYXNzID0gU3RyZWFtRGlzY29ubmVjdGVkKGFjdGlvblR5cGUpO1xuICAgICAgICAgIHRoaXMuc3RvcmUuZGlzcGF0Y2gobmV3IFN0cmVhbURpc2Nvbm5lY3RlZENsYXNzKGFjdGlvbikpO1xuICAgICAgICAgIHRoaXMuc3RvcmUuZGlzcGF0Y2goXG4gICAgICAgICAgICBuZXcgTmd4c0ZpcmVzdG9yZUNvbm5lY3RBY3Rpb25zLlN0cmVhbURpc2Nvbm5lY3RlZChzdHJlYW1JZCh7IGFjdGlvblR5cGUsIGFjdGlvbiwgdHJhY2tCeSB9KSlcbiAgICAgICAgICApO1xuICAgICAgICAgIHRoaXMuYWN0aXZlRmlyZXN0b3JlQ29ubmVjdGlvbnMuc3BsaWNlKFxuICAgICAgICAgICAgdGhpcy5hY3RpdmVGaXJlc3RvcmVDb25uZWN0aW9ucy5pbmRleE9mKHN0cmVhbUlkKHsgYWN0aW9uVHlwZSwgYWN0aW9uLCB0cmFja0J5IH0pKSxcbiAgICAgICAgICAgIDFcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgLy8gY29tcGxldGVkIGlmIFN0cmVhbUNvbXBsZXRlZFxuICAgICAgICAgIGlmIChjb25uZWN0ZWRBY3Rpb25GaW5pc2hlc09uID09PSAnU3RyZWFtQ29tcGxldGVkJykge1xuICAgICAgICAgICAgY29uc3QgeyBhY3Rpb25Db21wbGV0ZWRIYW5kbGVyU3ViamVjdCB9ID0gZ2V0U3ViamVjdHMoc3RyZWFtSWQoeyBhY3Rpb25UeXBlLCBhY3Rpb24sIHRyYWNrQnkgfSkpO1xuICAgICAgICAgICAgYWN0aW9uQ29tcGxldGVkSGFuZGxlclN1YmplY3QubmV4dChhY3Rpb24pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSksXG4gICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4ge1xuICAgICAgICAgIGNvbnN0IHsgYWN0aW9uQ29tcGxldGVkSGFuZGxlclN1YmplY3QgfSA9IGdldFN1YmplY3RzKHN0cmVhbUlkKHsgYWN0aW9uVHlwZSwgYWN0aW9uLCB0cmFja0J5IH0pKTtcbiAgICAgICAgICBhY3Rpb25Db21wbGV0ZWRIYW5kbGVyU3ViamVjdC5lcnJvcihlcnIpO1xuXG4gICAgICAgICAgY29uc3QgU3RyZWFtRXJyb3JlZENsYXNzID0gU3RyZWFtRXJyb3JlZChhY3Rpb25UeXBlKTtcbiAgICAgICAgICB0aGlzLnN0b3JlLmRpc3BhdGNoKG5ldyBTdHJlYW1FcnJvcmVkQ2xhc3MoYWN0aW9uLCBlcnIpKTtcblxuICAgICAgICAgIHJldHVybiBvZih7fSk7XG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH07XG5cbiAgICB0aGlzLmZpcmVzdG9yZUNvbm5lY3Rpb25zU3ViLnB1c2goYWN0aW9uRGlzcGF0Y2hlZCQucGlwZShtZXJnZU1hcChmaXJlc3RvcmVTdHJlYW1IYW5kbGVyJCkpLnN1YnNjcmliZSgpKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIGlmICh0aGlzLmZpcmVzdG9yZUNvbm5lY3Rpb25zU3ViKSB7XG4gICAgICB0aGlzLmZpcmVzdG9yZUNvbm5lY3Rpb25zU3ViLmZvckVhY2goKHN1YikgPT4gc3ViLnVuc3Vic2NyaWJlKCkpO1xuICAgIH1cbiAgfVxufVxuIl19