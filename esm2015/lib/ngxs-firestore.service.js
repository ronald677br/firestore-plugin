import { from, of } from 'rxjs';
import { Inject, Injectable } from '@angular/core';
import { map, take, mapTo, timeoutWith } from 'rxjs/operators';
import { NgxsFirestoreAdapter } from './ngxs-firestore.adapter';
import 'firebase/firestore';
export class NgxsFirestore {
    constructor(adapter) {
        this.adapter = adapter;
        this.idField = 'id';
        this.converter = {
            toFirestore: (value) => {
                return value;
            },
            fromFirestore: (snapshot, options) => {
                return Object.assign({}, snapshot.data(options));
            }
        };
    }
    createId() {
        return this.adapter.firestore.createId();
    }
    doc$(id) {
        return this.adapter.firestore
            .doc(this.docRef(id))
            .snapshotChanges()
            .pipe(map((docSnapshot) => {
            if (docSnapshot.payload.exists) {
                return this.getDataWithId(docSnapshot.payload);
            }
            else {
                return undefined;
            }
        }));
    }
    docOnce$(id) {
        return this.doc$(id).pipe(take(1));
    }
    collection$(queryFn = (ref) => ref) {
        return this.adapter.firestore
            .collection(this.path, (ref) => {
            return queryFn(ref.withConverter(this.converter));
        })
            .snapshotChanges()
            .pipe(map((docSnapshots) => docSnapshots.map((docSnapshot) => {
            return this.getDataWithId(docSnapshot.payload.doc);
        })));
    }
    collectionOnce$(queryFn) {
        return this.collection$(queryFn).pipe(take(1));
    }
    update$(id, value, setOptions) {
        return this.docSet(id, value, setOptions);
    }
    delete$(id) {
        return from(this.doc(id).delete()).pipe();
    }
    create$(value) {
        return this.upsert$(value);
    }
    upsert$(value, setOptions) {
        let id;
        let newValue;
        if (Object.keys(value).includes(this.idField) && !!value[this.idField]) {
            id = value[this.idField];
            newValue = Object.assign({}, value);
        }
        else {
            id = this.createId();
            newValue = Object.assign({}, value, { [this.idField]: id });
        }
        return this.docSet(id, newValue, setOptions);
    }
    getDataWithId(doc) {
        const data = doc.data();
        const id = (data && data[this.idField]) || doc.id;
        return Object.assign(Object.assign({}, data), { [this.idField]: id });
    }
    doc(id) {
        return this.adapter.firestore.doc(this.docRef(id));
    }
    docSet(id, value, setOptions) {
        setOptions = setOptions || { merge: true };
        if (this.isOffline()) {
            this.doc(id).set(value, setOptions);
            return of(id);
        }
        if (this.adapter.options && this.adapter.options.timeoutWriteOperations) {
            return from(this.doc(id).set(value, setOptions)).pipe(timeoutWith(this.adapter.options.timeoutWriteOperations, of(id)), mapTo(id));
        }
        else {
            return from(this.doc(id).set(value, setOptions)).pipe(mapTo(id));
        }
    }
    docRef(id) {
        return this.adapter.firestore.doc(`${this.path}/${id}`).ref.withConverter(this.converter);
    }
    isOffline() {
        return navigator.onLine !== undefined && !navigator.onLine;
    }
}
NgxsFirestore.decorators = [
    { type: Injectable }
];
NgxsFirestore.ctorParameters = () => [
    { type: NgxsFirestoreAdapter, decorators: [{ type: Inject, args: [NgxsFirestoreAdapter,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4cy1maXJlc3RvcmUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9saWIvbmd4cy1maXJlc3RvcmUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQWMsSUFBSSxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM1QyxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDL0QsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFFaEUsT0FBTyxvQkFBb0IsQ0FBQztBQVk1QixNQUFNLE9BQWdCLGFBQWE7SUFDakMsWUFBb0QsT0FBNkI7UUFBN0IsWUFBTyxHQUFQLE9BQU8sQ0FBc0I7UUFHdkUsWUFBTyxHQUFXLElBQUksQ0FBQztRQUN2QixjQUFTLEdBQWlEO1lBQ2xFLFdBQVcsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFO2dCQUNyQixPQUFPLEtBQUssQ0FBQztZQUNmLENBQUM7WUFDRCxhQUFhLEVBQUUsQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFLEVBQUU7Z0JBQ25DLHlCQUFnQixRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBRSxFQUFHO1lBQzVDLENBQUM7U0FDRixDQUFDO0lBWGtGLENBQUM7SUFhOUUsUUFBUTtRQUNiLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDM0MsQ0FBQztJQUVNLElBQUksQ0FBQyxFQUFVO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTO2FBQzFCLEdBQUcsQ0FBSSxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2FBQ3ZCLGVBQWUsRUFBRTthQUNqQixJ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QUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQ2xFO0lBQ0gsQ0FBQztJQUVPLE1BQU0sQ0FBQyxFQUFVO1FBQ3ZCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQzVGLENBQUM7SUFFTyxTQUFTO1FBQ2YsT0FBTyxTQUFTLENBQUMsTUFBTSxLQUFLLFNBQVMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUM7SUFDN0QsQ0FBQzs7O1lBdEhGLFVBQVU7OztZQWJGLG9CQUFvQix1QkFlZCxNQUFNLFNBQUMsb0JBQW9CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUXVlcnlGbiwgUXVlcnlEb2N1bWVudFNuYXBzaG90IH0gZnJvbSAnQGFuZ3VsYXIvZmlyZS9maXJlc3RvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgZnJvbSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgbWFwLCB0YWtlLCBtYXBUbywgdGltZW91dFdpdGggfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBOZ3hzRmlyZXN0b3JlQWRhcHRlciB9IGZyb20gJy4vbmd4cy1maXJlc3RvcmUuYWRhcHRlcic7XG5pbXBvcnQgZmlyZWJhc2UgZnJvbSAnZmlyZWJhc2UvYXBwJztcbmltcG9ydCAnZmlyZWJhc2UvZmlyZXN0b3JlJztcblxuLyoqXG4gKiBDaGFuZ2VzIHRoZSBiZWhhdmlvciBvZiBhIHNldCgpIGNhbGwgdG8gb25seSByZXBsYWNlIHRoZSB2YWx1ZXMgc3BlY2lmaWVkXG4gKiBpbiBpdHMgZGF0YSBhcmd1bWVudC4gRmllbGRzIG9taXR0ZWQgZnJvbSB0aGUgc2V0KCkgY2FsbCByZW1haW5cbiAqIHVudG91Y2hlZC5cbiAqL1xuaW50ZXJmYWNlIFNldE9wdGlvbnMge1xuICBtZXJnZTogYm9vbGVhbjtcbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIE5neHNGaXJlc3RvcmU8VD4ge1xuICBjb25zdHJ1Y3RvcihASW5qZWN0KE5neHNGaXJlc3RvcmVBZGFwdGVyKSBwcm90ZWN0ZWQgYWRhcHRlcjogTmd4c0ZpcmVzdG9yZUFkYXB0ZXIpIHt9XG5cbiAgcHJvdGVjdGVkIGFic3RyYWN0IHBhdGg6IHN0cmluZztcbiAgcHJvdGVjdGVkIGlkRmllbGQ6IHN0cmluZyA9ICdpZCc7XG4gIHByb3RlY3RlZCBjb252ZXJ0ZXI6IGZpcmViYXNlLmZpcmVzdG9yZS5GaXJlc3RvcmVEYXRhQ29udmVydGVyPFQ+ID0ge1xuICAgIHRvRmlyZXN0b3JlOiAodmFsdWUpID0+IHtcbiAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9LFxuICAgIGZyb21GaXJlc3RvcmU6IChzbmFwc2hvdCwgb3B0aW9ucykgPT4ge1xuICAgICAgcmV0dXJuIHsgLi4uKDxUPnNuYXBzaG90LmRhdGEob3B0aW9ucykpIH07XG4gICAgfVxuICB9O1xuXG4gIHB1YmxpYyBjcmVhdGVJZCgpIHtcbiAgICByZXR1cm4gdGhpcy5hZGFwdGVyLmZpcmVzdG9yZS5jcmVhdGVJZCgpO1xuICB9XG5cbiAgcHVibGljIGRvYyQoaWQ6IHN0cmluZyk6IE9ic2VydmFibGU8VD4ge1xuICAgIHJldHVybiB0aGlzLmFkYXB0ZXIuZmlyZXN0b3JlXG4gICAgICAuZG9jPFQ+KHRoaXMuZG9jUmVmKGlkKSlcbiAgICAgIC5zbmFwc2hvdENoYW5nZXMoKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcCgoZG9jU25hcHNob3QpID0+IHtcbiAgICAgICAgICBpZiAoZG9jU25hcHNob3QucGF5bG9hZC5leGlzdHMpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldERhdGFXaXRoSWQoZG9jU25hcHNob3QucGF5bG9hZCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBkb2NPbmNlJChpZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxUPiB7XG4gICAgcmV0dXJuIHRoaXMuZG9jJChpZCkucGlwZSh0YWtlKDEpKTtcbiAgfVxuXG4gIHB1YmxpYyBjb2xsZWN0aW9uJChxdWVyeUZuOiBRdWVyeUZuID0gKHJlZikgPT4gcmVmKTogT2JzZXJ2YWJsZTxUW10+IHtcbiAgICByZXR1cm4gdGhpcy5hZGFwdGVyLmZpcmVzdG9yZVxuICAgICAgLmNvbGxlY3Rpb248VD4odGhpcy5wYXRoLCAocmVmKSA9PiB7XG4gICAgICAgIHJldHVybiBxdWVyeUZuKHJlZi53aXRoQ29udmVydGVyKHRoaXMuY29udmVydGVyKSk7XG4gICAgICB9KVxuICAgICAgLnNuYXBzaG90Q2hhbmdlcygpXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKChkb2NTbmFwc2hvdHMpID0+XG4gICAgICAgICAgZG9jU25hcHNob3RzLm1hcCgoZG9jU25hcHNob3QpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldERhdGFXaXRoSWQoZG9jU25hcHNob3QucGF5bG9hZC5kb2MpO1xuICAgICAgICAgIH0pXG4gICAgICAgIClcbiAgICAgICk7XG4gIH1cblxuICBwdWJsaWMgY29sbGVjdGlvbk9uY2UkKHF1ZXJ5Rm4/OiBRdWVyeUZuKTogT2JzZXJ2YWJsZTxUW10+IHtcbiAgICByZXR1cm4gdGhpcy5jb2xsZWN0aW9uJChxdWVyeUZuKS5waXBlKHRha2UoMSkpO1xuICB9XG5cbiAgcHVibGljIHVwZGF0ZSQoaWQ6IHN0cmluZywgdmFsdWU6IFBhcnRpYWw8VD4sIHNldE9wdGlvbnM/OiBTZXRPcHRpb25zKSB7XG4gICAgcmV0dXJuIHRoaXMuZG9jU2V0KGlkLCB2YWx1ZSwgc2V0T3B0aW9ucyk7XG4gIH1cblxuICBwdWJsaWMgZGVsZXRlJChpZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIGZyb20odGhpcy5kb2MoaWQpLmRlbGV0ZSgpKS5waXBlKCk7XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlJCh2YWx1ZTogUGFydGlhbDxUPik6IE9ic2VydmFibGU8c3RyaW5nPiB7XG4gICAgcmV0dXJuIHRoaXMudXBzZXJ0JCh2YWx1ZSk7XG4gIH1cblxuICBwdWJsaWMgdXBzZXJ0JCh2YWx1ZTogUGFydGlhbDxUPiwgc2V0T3B0aW9ucz86IFNldE9wdGlvbnMpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICAgIGxldCBpZDtcbiAgICBsZXQgbmV3VmFsdWU7XG5cbiAgICBpZiAoT2JqZWN0LmtleXModmFsdWUpLmluY2x1ZGVzKHRoaXMuaWRGaWVsZCkgJiYgISF2YWx1ZVt0aGlzLmlkRmllbGRdKSB7XG4gICAgICBpZCA9IHZhbHVlW3RoaXMuaWRGaWVsZF07XG4gICAgICBuZXdWYWx1ZSA9IE9iamVjdC5hc3NpZ24oe30sIHZhbHVlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWQgPSB0aGlzLmNyZWF0ZUlkKCk7XG4gICAgICBuZXdWYWx1ZSA9IE9iamVjdC5hc3NpZ24oe30sIHZhbHVlLCB7IFt0aGlzLmlkRmllbGRdOiBpZCB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5kb2NTZXQoaWQsIG5ld1ZhbHVlLCBzZXRPcHRpb25zKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RGF0YVdpdGhJZDxURGF0YT4oZG9jOiBRdWVyeURvY3VtZW50U25hcHNob3Q8VERhdGE+KSB7XG4gICAgY29uc3QgZGF0YSA9IGRvYy5kYXRhKCk7XG4gICAgY29uc3QgaWQgPSAoZGF0YSAmJiBkYXRhW3RoaXMuaWRGaWVsZF0pIHx8IGRvYy5pZDtcbiAgICByZXR1cm4geyAuLi5kYXRhLCBbdGhpcy5pZEZpZWxkXTogaWQgfTtcbiAgfVxuXG4gIHByaXZhdGUgZG9jKGlkOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5hZGFwdGVyLmZpcmVzdG9yZS5kb2ModGhpcy5kb2NSZWYoaWQpKTtcbiAgfVxuXG4gIHByaXZhdGUgZG9jU2V0KGlkOiBzdHJpbmcsIHZhbHVlOiBhbnksIHNldE9wdGlvbnM/OiBTZXRPcHRpb25zKSB7XG4gICAgc2V0T3B0aW9ucyA9IHNldE9wdGlvbnMgfHwgeyBtZXJnZTogdHJ1ZSB9O1xuXG4gICAgaWYgKHRoaXMuaXNPZmZsaW5lKCkpIHtcbiAgICAgIHRoaXMuZG9jKGlkKS5zZXQodmFsdWUsIHNldE9wdGlvbnMpO1xuICAgICAgcmV0dXJuIG9mKGlkKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5hZGFwdGVyLm9wdGlvbnMgJiYgdGhpcy5hZGFwdGVyLm9wdGlvbnMudGltZW91dFdyaXRlT3BlcmF0aW9ucykge1xuICAgICAgcmV0dXJuIGZyb20odGhpcy5kb2MoaWQpLnNldCh2YWx1ZSwgc2V0T3B0aW9ucykpLnBpcGUoXG4gICAgICAgIHRpbWVvdXRXaXRoKHRoaXMuYWRhcHRlci5vcHRpb25zLnRpbWVvdXRXcml0ZU9wZXJhdGlvbnMsIG9mKGlkKSksXG4gICAgICAgIG1hcFRvKGlkKVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGZyb20odGhpcy5kb2MoaWQpLnNldCh2YWx1ZSwgc2V0T3B0aW9ucykpLnBpcGUobWFwVG8oaWQpKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGRvY1JlZihpZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMuYWRhcHRlci5maXJlc3RvcmUuZG9jKGAke3RoaXMucGF0aH0vJHtpZH1gKS5yZWYud2l0aENvbnZlcnRlcih0aGlzLmNvbnZlcnRlcik7XG4gIH1cblxuICBwcml2YXRlIGlzT2ZmbGluZSgpIHtcbiAgICByZXR1cm4gbmF2aWdhdG9yLm9uTGluZSAhPT0gdW5kZWZpbmVkICYmICFuYXZpZ2F0b3Iub25MaW5lO1xuICB9XG59XG4iXX0=